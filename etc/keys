#!/usr/bin/env bash

usage() {
    echo
    echo "$(ansi bold Generate an age public key pair and backup documentation)."
    echo
    echo "Usage: $(ansi bold_blue valt keys ${scriptName}) [OPTIONS] [NAME]"
    echo
    echo "If no name is specified it defaults to 'my'."
    echo
    echo "Private keys are encrypted and a strong passphrase is $(ansi bold_green highly) encouraged; advice and an opportunity to"
    echo "generate one will be offered."
    echo
    echo "A PDF file will be created containing your keys, also in encrypted form, to serve as a backup for you and/or your"
    echo "successors. Keys are represented as a QR code and again in a text format â€” when printed, such representations are often"
    echo "called \"paper keys\". Detailed usage instructions are included and should be personalized with information (e.g. emergency contacts)"
    echo "that you supply in a separate file via the --document option. When not specified, an example file will be used."
    echo
    echo "Space is provided in the document for you to record your passphrase by hand. Please do so, and then:"
    echo
    echo "      $(ansi bold store the document in a secure location such as a safe deposit box or fire safe!)"
    echo
    echo "Better, store copies in multiple secure places, perhaps also with a trusted friend or family member."
    echo
    echo "Options"
    echo
    echo "    -f, --force                   Overwrite existing files."
    echo "    --no-verify                   Do not verify keys."
    echo "    --no-advice                   Do not show passphrase advice."
    echo "    -q, --quick                   Do not verify keys or show passphrase advice."
    echo "    -d, --document SUBSTITUTIONS  Use the SUBSTITUTIONS file when generating the document."
    echo "    -t, --template TEMPLATE       Use the TEMPLATE markdown file instead of the default for PDF generation."
    echo "    -c, --css CSS                 Apply style overrides from the CSS file for PDF generation."
    echo "    -h, --help                    Display usage and exit."
    echo
    echo "Document Customization"
    echo
    echo "Substitutions are performed with simple key/value pairs defined in a file such as:"
    echo
    echo "    ${exampleSubstitutionsFile}"
    echo
    echo "Substitution keys are brace delimited within a template file, where the default is:"
    echo
    echo "    ${templateFile}"
    echo
    echo "Substitution keys with an underscore prefix are reserved for system use."
    echo
    echo "Default styles can be extended using the --css option to override the base CSS rules in:"
    echo
    echo "    ${cssMainFile}"
    echo
    bye
}

main() {
    init "${@}"
    createKeys
    if [[ ${substitutionsFile} ]]; then
        createKeyDocument
    fi
    echo
}

init() {
    allNewFilesUserOnly
    readonly scriptName=$(basename "${0}")
    readonly exampleSubstitutionsFile="${VALT_ETC_DIR}/key-doc-example-substitutions.sh"
    readonly cssMainFileName="key-doc.css"
    readonly cssOverrideFileName='override.css'
    readonly logoFileName="phoggy.png"
    readonly htmlFileName='note.html'
    readonly qrCodeFileName='qr.png'
    readonly cssMainFile="${VALT_ETC_DIR}/${cssMainFileName}"
    readonly logoFile="${VALT_ETC_DIR}/${logoFileName}"

    templateFile="${VALT_ETC_DIR}/key-doc-template.html"
    substitutionsFile="${exampleSubstitutionsFile}"
    cssOverrideFile=
    htmlFile=
    prefix="${USER}"
    htmlFile=
    qrCodeFile=
    armoredKey=

    # Flags
    declare -i force=0
    declare -i showKeyAdvice=1
    declare -i verifyKeys=1

    while ((${#} > 0)); do
        case "${1}" in
            -d | --document) shift; setSubstitutionsFile "${1}" ;;
            -t | --template) shift; setFileVar templateFile "${1}" "TEMPLATE" ;;
            -c | --css) shift; setFileVar cssOverrideFile "${1}" "CSS" ;;
            --no-verify) verifyKeys=0 ;;
            --no-advice) showKeyAdvice=0 ;;
            -q | --quick) showKeyAdvice=0; verifyKeys=0 ;;
            -f | --force) force=1 ;;
            -h | --help) usage ;;
            *) setPrefix "${1}" ;;
        esac
        shift
    done

    privateKeyFile="${PWD}/${prefix}.key"
    publicKeyFile="${PWD}/${prefix}-public.key"
    documentsFile="${PWD}/${prefix}-key.pdf"

    if (( force )); then
        rm "${publicKeyFile}" "${privateKeyFile}" 2> /dev/null
    else
        assertFileDoesNotExist "${privateKeyFile}"
        assertFileDoesNotExist "${publicKeyFile}"
    fi
}

setPrefix() {
    assertValidFileName "${1}"
    prefix="${1}"
}

setSubstitutionsFile() {
    local file="${1}"
    [[ ${file} == 'example' ]] && file="${exampleSubstitutionsFile}"
    setFileVar substitutionsFile "${file}" "SUBSTITUTIONS"
    [[ ${force} ]] || assertFileDoesNotExist "${documentsFile}"
}

createKeys() {
    echo
    echo "$(ansi bold Generating keys)"
    if (( showKeyAdvice )); then
        echo
        showAgeKeyPairAdvice
        local reply
        read -t ${inputTimeout} -p "Would you like help generating a passphrase? (y/n): " reply
        echo
        [[ ${reply,,} == 'y' ]] && generatePass
    fi
    createAgeKeyPair "${privateKeyFile}" "${publicKeyFile}" || fail
    echo
    echo "Public key (aka 'recipient') file: $(ansi cyan ${publicKeyFile})"
    echo "Private key (aka 'identity') file: $(ansi cyan ${privateKeyFile}) (also contains public key)"

    if (( verifyKeys )); then
        echo
        echo "$(ansi bold Verifying keys)"
        echo
        verifyAgeKeyPair "${privateKeyFile}" "${publicKeyFile}"
        echo
        echo "$(ansi bold_green Verified) that a file encrypted with $(ansi cyan ${publicKeyFile}) decrypts with passphrase and $(ansi cyan ${privateKeyFile})."
    fi
}

generatePass() {
    echo "$(ansi bold_yellow TODO): implement generatePass()!" # TODO!!
    echo
}

createKeyDocument() {
    local options=
    echo
    echo "$(ansi bold Generating documentation)"
    echo
    generatePdf
    echo
    echo "Keys documented in $(ansi cyan ${documentsFile})"
    open "${documentsFile}" &> /dev/null
}

# TODO: --+----+-++(-++(---++++(---+(((+)))+---)++++---)++-)++-+-----+--

generatePdf() {
    local workDir=$(tempDirPath)

    # Set armoredKey var

    armorAgeFile "${privateKeyFile}" armoredKey

    # Copy required files

    cp "${cssMainFile}" "${workDir}/${cssMainFileName}" || fail
    cp "${logoFile}" "${workDir}/${logoFileName}" || fail
    if [[ ${cssOverrideFile} ]]; then
        cp "${cssOverrideFile}" "${workDir}/${cssOverrideFileName}" || fail
    fi

    # Create QR code

    qrCodeFile="${workDir}/${qrCodeFileName}"
    echo "${armoredKey}" | qrencode -l H -o "${qrCodeFile}" || fail
    assertFileExists "${qrCodeFile}"

    # Generate substituted html file

    htmlFile="${workDir}/${htmlFileName}"
    author="$(generateHtml "${htmlFile}")"
    assertFileExists "${htmlFile}"

    # Move to work dir so that relative paths in html work correctly

    cd ${workDir} || fail

    # Convert html to pdf

    wkhtmltopdf --enable-local-file-access \
        --footer-left "${author} Private Key" \
        --footer-center "$(date '+%B %e, %Y')" \
        --footer-right "Page [page] of [topage]" \
        --footer-font-name "Helvetica, Arial, sans-serif" \
        --footer-font-size 8 \
        --margin-bottom 15mm \
        "${htmlFile}" "${documentsFile}"

    # Set metadata and encrypt with a strong password

    local valtProjectUrl='https://github.com/phoggy/valt'
    local title='Private Key Pair Backup & Usage Instructions'
    local creator="$(projectVersion valt), ${valtProjectUrl}"
    local subject="File decryption."
    local keywords="${author}, valt, private key, backup, encryption, decryption, security"

    exiftool \
        -Title="${title}" \
        -Author="${author}" \
        -Subject="${subject}" \
        -Keywords="${keywords}" \
        -Creator="${creator}" \
        -overwrite_original \
        "${documentsFile}"  > /dev/null

    # Encrypt with a strong owner password so that permissions cannot be changed, ensuring
    # that the user password is empty so viewing does not require a password. The owner
    # password should never be required. Note that if we ever want actual form fields,
    # the --modify option must be changed to allow filling.

    local ownerPW="$(phraze)"
    local userPW=''

    qpdf ${documentsFile} \
        --encrypt "${userPW}" "${ownerPW}" 256 --modify=none -- \
        --replace-input
}

generateHtml() {
    local outputFile="${1}"
    local html="$(< ${templateFile})" || fail
    local contact value

    # Set user provided substitutions

    sourceSafeStaticVars "${substitutionsFile}"

    # Set built-in substitution values(clobbering any that the user might have defined)

    local _DATE="$(date "+%B %d, %Y %r %Z")"
    local _CSS_PATH="${cssMainFileName}"
    local _LOGO_PATH="${logoFileName}"
    local _QR_CODE_PATH="${qrCodeFileName}"
    local _ARMORED_KEY="${armoredKey}"
    local _CONTACTS_LIST= # transformed later
    local _CSS_OVERRIDE='<!-- placeholder -->'
    if [[ ${cssOverrideFile} ]]; then
        _CSS_OVERRIDE="<link rel="stylesheet" href="${cssOverrideFileName}">"
    fi

    # Collect all required substitution keys (consumes tempHtml)

    local tempHtml="${html}"
    local requiredSubstitutionKeys=()

    while [[ ${tempHtml} =~ ([^{]*)\}(.*) ]]; do
        requiredSubstitutionKeys+=("${BASH_REMATCH[1]}")
        tempHtml="${BASH_REMATCH[2]}"
    done

    # Insist on an 'author' var in template

    [[ "${author}" ]] || fail "'${author}' is required in ${templateFile}"

    # Perform the substitutions, failing if a required substitution is not defined

    for key in "${requiredSubstitutionKeys[@]}"; do
        value="${!key}"
        [[ -v "${key}" ]] || fail "${key} not set in ${substitutionsFile}"

        # Special case contacts and transform into list items

        if [[ ${key} == '_CONTACTS_LIST' ]]; then
            value=
            for contact in "${contacts[@]}"; do
                value+="<li>${contact}</li>"
            done
        fi
        [[ "${value}" ]] || fail "${key} value not set in ${substitutionsFile}"
        html=${html/\$\{${key}\}/${value}}
    done
    echo "${html}" > "${outputFile}"

    echo "${author}"
}

source rayvn.up --add valt 'rayvn/core' 'rayvn/safe-env' 'valt/age' 'valt/password'

main "${@}"
