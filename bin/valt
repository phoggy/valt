#!/usr/bin/env bash
# shellcheck disable=SC2155

usage() {
    echo
    echo "$(ansi bold Public key encryption of files and directories, using) $(ansi cyan rage) (see $(ansi blue ${rageProjectUrl}))."
    echo
    echo "Usage: $(ansi bold_blue ${projectName}) [OPTIONS] $(ansi italic COMMAND)"
    echo
    echo "Commands"
    echo
    echo "    pass                  Generate and/or evaluate password/passphrase strength."
    echo "    keys                  Generate a public key pair, with encrypted private key."
    echo "    encrypt               Encrypt one or more files or directories."
    echo "    decrypt               Decrypt a '.valt' file."
    echo "    append                Append one or more files to an existing .valt file." # TODO!!
    echo
    echo "Options"
    echo
    echo "    -h, --help            Print this help message and exit."
    echo "    -v                    Print the version and exit."
    echo "    --version             Print the version with release date and exit."
    echo "    --visibility MODE     Set password/phrase input visibility: 'none', 'hide', or 'show' (default=none)."
    echo
    echo "Environment Variables"
    echo
    echo "    VALT_VISIBILITY       Set default visibility mode."
    echo "    VALT_TIMEOUT          Set input timeout, in seconds. Defaults to 30."
    echo
    echo "Run $(ansi bold_blue ${projectName})$(ansi italic COMMAND) $(ansi bold_blue --help) for more information on a command."
    echo
    bye "${@}"
}

main() {
    init "${@}"
    if [[ ${command} ]]; then
        source ${command} -- ${commandOptions}
    else
        usage
    fi
}

init() {
    allNewFilesUserOnly
    useValtPinEntry
    readonly rageProjectUrl='https://github.com/str4d/rage'

    # Global constants

    declare -grx valtEtcDir="${valtHome}/etc"
    declare -grx valtConfigDir="$(configDirPath)"
    declare -grx valtProjectUrl='https://github.com/phoggy/valt'
    declare -grx webPasswordGenUrl='https://bitwarden.com/password-generator/'
    declare -grx webHaveIBeenPwnedUrl="https://haveibeenpwned.com/Passwords"
    declare -grx webXkcdPasswordsUrl="https://xkcd.com/936/"

    # Global options

    declare -gx passwordVisibility="${VALT_VISIBILITY:-none}"           # none|hide|show
    declare -gx expertMode="${VALT_EXPERT_MODE:-}"                      # any value enables
    declare -grx inputTimeout="${VALT_INPUT_TIMEOUT:-30}"               # seconds

    # Arguments

    command=
    commandOptions=

    # Parse input

    [[ ${1} ]] || usage

    while (( ${#} > 0 )); do
        case "${1}" in
            pass) setCommand pass ;; # TODO implement!!
            keys) setCommand keys ;;
            encrypt) setCommand encrypt ;;
            decrypt) setCommand decrypt ;;
            --expert) expertMode=true ;; # TODO update usage when implemented
            --visibility) shift; passwordVisibility="${1}" ;;
            -h | --help) [[ ${command} ]] && appendVar commandOptions "${1}" || usage ;;
            -v) projectVersion valt; exit 0 ;;
            --version) projectVersion valt true; exit 0 ;;
            --debug) setDebug showOnExit ;;
            --debug-new) setDebug clearLog showOnExit ;;
            --debug-out) setDebug tty "${terminal}" ;;
            --debug-tty) shift; setDebug tty "${1}" ;;
            *) appendVar commandOptions "${1}" ;;
        esac
        shift
    done

    debugVars passwordVisibility expertMode proxyPinEntry command commandOptions

    assertValidVisibility
    [[ ${command} ]] || usage "missing command"
}

setCommand() {
    command="${valtEtcDir}/${1}"
}

assertValidVisibility() {
    case "${passwordVisibility}" in
        none | hide | show) ;;
        *) usage "unknown visibility mode: '${passwordVisibility}'"
    esac
}

# Boot rayvn with initial required libraries

source rayvn.up --add 'valt' 'rayvn/core' 'valt/age'

main "${@}"



