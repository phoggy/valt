#!/usr/bin/env bash
# shellcheck disable=SC2155

usage() {
    echo
    echo "$(ansi bold Public key encryption of files and directories, using) $(ansi cyan rage) (see $(ansi blue ${rageProjectUrl}))."
    echo
    echo "Usage: $(ansi bold_blue ${scriptName}) [OPTIONS] $(ansi italic COMMAND)"
    echo
    echo "Options"
    echo
    echo "    -h, --help            Display usage and exit."
    echo "    -v, --version         Display version and exit."
    echo "    --visibility MODE     Set password/phrase input visibility: 'none', 'hide', or 'show' (default)."
    echo
    echo "Commands"
    echo
    echo "    pass                  Generate and/or evaluate password/passphrase strength."
    echo "    keys                  Generate a public key pair, with encrypted private key."
    echo "    encrypt               Encrypt one or more files or directories."
    echo "    decrypt               Decrypt an '.valt' file."
    echo
    echo "Environment Variables"
    echo
    echo "    VALT_VISIBILITY       Set default visibility mode."
    echo "    VALT_TIMEOUT          Set input timeout, in seconds. Defaults to 30."
    echo
    echo "Run $(ansi bold_blue ${scriptName}) $(ansi italic COMMAND) $(ansi bold_blue --help) for more information on a command."
    echo
    bye "${@}"
}

main() {
    init "${@}"
    if [[ ${command} ]]; then
        #echo "RUN: ${command} ${commandOptions}"
       ${command} ${commandOptions}
    else
        #echo "usage"
        usage
    fi
}

init() {
    useRayvnPinEntry
    readonly scriptName="$(basename "${0}")"
    readonly scriptHome=$(realpath "$(dirname "${0}/../../..")")
    readonly rageProjectUrl='https://github.com/str4d/rage'

    # Global constants

    declare -grx VALT_PROJECT_URL='https://github.com/phoggy/sage'
    declare -grx VALT_ETC_DIR="${scriptHome}/etc"
    declare -grx webPasswordGenUrl='https://bitwarden.com/password-generator/'
    declare -grx webHaveIBeenPwnedUrl="https://haveibeenpwned.com/Passwords"
    declare -grx webXkcdPasswordsUrl="https://xkcd.com/936/"

    # Global options

    declare -gx passwordVisibility="${VALT_VISIBILITY:-show}"           # none|hide|show
    declare -gx expertMode="${VALT_EXPERT_MODE:-}"                      # any value enables
    declare -grx inputTimeout="${VALT_INPUT_TIMEOUT:-30}"               # seconds

    # Arguments

    command=
    commandOptions=

    # Parse input

    [[ ${1} ]] || usage

    while (( ${#} > 0 )); do
        case "${1}" in
            pass) setCommand pass ;;
            keys) setCommand keys ;;
            encrypt) setCommand encrypt ;;
            decrypt) setCommand decrypt ;;
            --expert) expertMode=true ;; # TODO update usage when implemented
            --visibility) shift; passwordVisibility="${1}" ;;
            -v) version valt; exit 0 ;;
            --version) version valt true; exit 0 ;;
            --debug) setDebug showOnExit ;;
            --debug-new) setDebug clearLog showOnExit ;;
            --debug-out) setDebug noLog ;;
            -h | --help) [[ ${command} ]] && appendVar commandOptions "${1}" || usage ;;
            *) appendVar commandOptions "${1}" ;;
        esac
        shift
    done

    debugVars passwordVisibility expertMode proxyPinEntry command commandOptions

    assertValidVisibility
    [[ ${command} ]] || usage "missing command"
}

setCommand() {
    command="${VALT_ETC_DIR}/${1}"
}

assertValidVisibility() {
    case "${passwordVisibility}" in
        none | hide | show) ;;
        *) usage "unknown visibility mode: '${passwordVisibility}'"
    esac
}

# Boot rayvn with initial required libraries

source rayvn.up --add 'valt' 'rayvn/core' 'rayvn/age' 'rayvn/debug'

# [[ ${VALT_DEBUG} ]] && setDebug ${VALT_DEBUG} # TODO move to init

main "${@}"



